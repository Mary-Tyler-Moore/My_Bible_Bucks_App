<!DOCTYPE html>
<html lang="en">

<head>
    <META NAME="robots" CONTENT="noindex,nofollow">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>K - 1 Bible Bucks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link rel="icon" href="favicon.png" sizes="16x16">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <h1>Bible Bucks</h1>
        <h3>K-1</h3>
        <br>
        <div>
            <button class="btn btn-primary btn-lg fw-bold" onclick="window.location.href='/index.html'">Home</button>
        </div>
        <br>
        <div class="row mt-3">
            <div class="col-md-12">
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <a class="nav-item nav-link active" id="nav-all-users-tab" data-toggle="tab"
                            href="#nav-all-users" role="tab" aria-controls="nav-all-users" aria-selected="true">K-1</a>
                    </div>
                </nav>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-all-users" role="tabpanel"
                        aria-labelledby="nav-all-users-tab">
                        <div class="row">
                            <div class="col-md-10 bg-light pt-2">
                                <div class="users" style="min-height: 500px; ">
                                    <table class="table table-striped table-bordered">
                                        <thead>
                                            <tr>
                                                <th scope="col">#</th>
                                                <th scope="col">Child's Name</th>
                                                <th scope="col">Bible Bucks</th>
                                            </tr>
                                        </thead>
                                        <tbody class="user-lists">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-add-user" role="tabpanel" aria-labelledby="nav-add-user-tab">
                        <div class="row">
                            <div class="col-md-10 bg-light pt-2">
                                <form class="add-user-form" style="min-height: 500px; ">
                                    <div class="form-group">
                                        <label for="add_full_name">Full Name</label>
                                        <input type="text" class="form-control" id="add_full_name"
                                            placeholder="Full Name" name="full_name" value="">
                                    </div>
                                    <div class="form-group">
                                        <label for="add_bucks">Bible Bucks</label>
                                        <input type="text" class="form-control" id="add_bucks" placeholder="Bible Bucks"
                                            name="bucks" value="">
                                    </div>
                                    <div class="form-group">
                                        <button type="button" class="btn btn-primary btn-block" id="btn-add-user">Add
                                            User
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="nav-update-user" role="tabpanel"
                        aria-labelledby="nav-update-user-tab">
                        <div class="row">
                            <div class="col-md-10 bg-light pt-2">
                                <form class="update-user-form" style="min-height: 500px; ">
                                    <div class="form-group">
                                        <label for="update-user-id">Select Child</label>
                                        <select class="custom-select user-select-list" id="update-user-id" name="id">
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="update_full_name">Full Name</label>
                                        <input type="text" class="form-control" id="update_full_name"
                                            placeholder="Full Name" name="full_name" value="">
                                    </div>
                                    <div class="form-group">
                                        <label for="update_bucks">Bible Bucks</label>
                                        <input type="text" class="form-control" id="update_bucks"
                                            placeholder="Bible Bucks" name="bucks" value="">
                                    </div>
                                    <div class="form-group">
                                        <button type="button" class="btn btn-primary btn-block"
                                            id="btn-update-user">Update
                                            User
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-delete-user" role="tabpanel"
                        aria-labelledby="nav-delete-user-tab">
                        <div class="row">
                            <div class="col-md-10 bg-light pt-2">
                                <form style="min-height: 500px; ">
                                    <div class="form-group">
                                        <label for="delete-user-id">Select User</label>
                                        <select class="custom-select user-select-list" id="delete-user-id" name="id">
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <button type="button" class="btn btn-primary btn-block"
                                            id="btn-delete-user">Delete
                                            User
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <br>
    <br>
    <br>
    <br>
    <main2>
        <div style="display:none" class="container">
            <div class="card shadow-lg rounded-4 form-signin w-100 m-auto">
                <div class="card-body">
                    <div id="dashboard">
                        <div class="text-center mx-auto">
                        </div>
                        <p id="profile_email" class="text-center"></p>
                        <div class="d-grid gap-3 mt-3">
                            <button style="display:none" class="btn btn-dark btn-lg fw-bold" type="button"
                                id="emailverifybtn">Verify
                                E-mail</button>
                            <button style="display:none" class="btn btn-secondary btn-lg fw-bold" type="button"
                                data-bs-toggle="modal" data-bs-target="#exampleModal">Change Password</button>
                            <button style="display:none" class="btn btn-danger btn-lg fw-bold" type="button"
                                id="deleteusrbtn">Delete
                                Account</button>
                            <button style="display:none" class="btn btn-primary btn-lg fw-bold" type="button"
                                id="logoutbtn">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main2>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Change Your Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="changePassword" class="needs-validation" novalidate autocomplete="off">
                    <div class="modal-body">
                        <div class="mx-3">
                            <div id="usr_pwd" class="mt-2">
                                <label for="user_passwd" class="form-label fs-5">Password</label>
                                <input type="password" class="form-control form-control-lg mb-2" id="user_passwd"
                                    placeholder="Enter Your Password" aria-placeholder="Enter Your Password" required>
                                <span class="text-danger" id="passwd_err"></span>
                            </div>
                            <div id="usr_pwd" class="mt-2">
                                <label for="user_passwd" class="form-label fs-5">Confirm Password</label>
                                <input type="password" class="form-control form-control-lg mb-2" id="user_confpasswd"
                                    placeholder="Enter Your Confirm Password"
                                    aria-placeholder="Enter Your Confirm Password" required>
                                <span class="text-danger" id="confpasswd_err"></span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <br>
    <br>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
        integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-firestore.js"></script>

    <script>
        $(document).ready(function () {
            let user_container = $('.user-lists');
            let users = [];
            firebase.initializeApp({
                apiKey: "AIzaSyCGJmVhr_u7280kYEDjyYPHae_W1JQv6EI",
                authDomain: "bible-bucks-dev.firebaseapp.com",
                projectId: "bible-bucks-dev",
            });
            $('#btn-delete-user').click(function () {
                delete_user($('#delete-user-id').val());
            });
            $("#btn-add-user").on("click", function (event) {
                event.preventDefault();
                let user_data = $('.add-user-form').serializeArray();
                let request_data = {}
                $.each(user_data, function (key, value) {
                    request_data[value.name] = value.value;
                });
                add_user(request_data)
            })
            $('#update-user-id').change(function (event) {
                update_usere_info_on_user_change(event.target.value);
            });
            $("#btn-update-user").on("click", function (event) {
                event.preventDefault();
                let user_data = $('.update-user-form').serializeArray();
                let request_data = {}
                $.each(user_data, function (key, value) {
                    request_data[value.name] = value.value;
                });
                update_user(request_data)
            });
            let db = firebase.firestore();
            db.collection("K-1 Bible Bucks")
                .onSnapshot((snapshot) => {
                    user_container.append('');
                    snapshot.docChanges().forEach((change) => {
                        let type = change.type;
                        let data = change.doc.data();
                        let id = change.doc.id;
                        if (type === "added") {
                            users.push({
                                'id': id,
                                'full_name': data.full_name,
                                'bucks': data.bucks,
                            })
                        }
                        if (type === "modified") {
                            let index = users.findIndex(x => x.id === id);
                            users[index] = {
                                'id': id,
                                'full_name': data.full_name,
                                'bucks': data.bucks,
                            }
                        }
                        if (type === "removed") {
                            let index = users.findIndex(x => x.id === id);
                            users.splice(index, 1);
                        }
                    });
                    update_user_details();
                    update_user_select_list();
                });

            function update_user_details () {
                let table_data = '';
                user_container.text(table_data);
                $.each(users, function (index, user) {
                    table_data += `<tr>
                        <td>${index + 1}.</td>
                        <td>${user.full_name}</td>
                        <td>${user.bucks}</td>
                        </tr>`
                });
                user_container.append(table_data);
            }
            function update_user_select_list () {
                let table_data = `<option value=''>Select User</option>`;
                let container = $('.user-select-list');
                container.text(table_data)
                $.each(users, function (index, user) {
                    table_data += `<option value=${user.id}>${user.full_name}</option>`
                });
                container.html(table_data)
            }
            function add_user (data) {
                db.collection("K-1 Bible Bucks").add(data).then(() => {
                    swal({
                        title: "User successfully Added!",
                        icon: "success",
                        button: "Close",
                    });
                    $('.add-user-form')[0].reset();
                }).catch((error) => {
                    swal({
                        title: "Error Adding user",
                        icon: "error",
                        button: "Close",
                    });
                });
            }
            function update_user (data) {
                let user_id = data.id;
                if (!user_id) {
                    return swal({
                        title: "Please select the user",
                        icon: "error",
                        button: "Close",
                    });
                }
                delete data.id;
                db.collection("K-1 Bible Bucks").doc(user_id).update(data).then(() => {
                    swal({
                        title: "User successfully updated!",
                        icon: "success",
                        button: "Close",
                    });
                    $('.update-user-form')[0].reset();
                }).catch((error) => {
                    swal({
                        title: "Error updating user",
                        icon: "error",
                        button: "Close",
                    });
                });
            }
            function delete_user (user_id) {
                if (!user_id) {
                    return swal({
                        title: "Please select the user",
                        icon: "error",
                        button: "Close",
                    });
                }
                db.collection("K-1 Bible Bucks").doc(user_id).delete().then(() => {
                    swal({
                        title: "User successfully deleted!",
                        icon: "success",
                        button: "Close",
                    });
                }).catch((error) => {
                    swal({
                        title: "Error deleting User",
                        icon: "error",
                        button: "Close",
                    });
                });
            }
            function update_usere_info_on_user_change (user_id) {
                let user_data = users.find(x => x.id === user_id)
                if (user_data) {
                    $('#update_full_name').val(user_data.full_name);
                    $('#update_address').val(user_data.address);
                    $('#update_phone').val(user_data.phone);
                    $('#update_bucks').val(user_data.bucks);
                }
            }
        });
    </script>

    <script type="module">
        import { validPasswd, validConfPasswd } from './Assets/validation.js';
        import { checkAfterAuth, logOut, delUser, emailVerify, changePassword } from './Assets/main.js';

        document.getElementById('user_passwd').addEventListener("blur", validPasswd);
        document.getElementById('user_confpasswd').addEventListener("blur", validConfPasswd);

        document.getElementById("changePassword").onsubmit = function () { return changepasswd() };

        document.getElementById('emailverifybtn').addEventListener("click", emailVerify);
        document.getElementById('deleteusrbtn').addEventListener("click", delUser);
        document.getElementById('logoutbtn').addEventListener("click", logOut);
        document.addEventListener("DOMContentLoaded", checkAfterAuth);

        function changepasswd () {
            try {
                validPasswd();
                validConfPasswd();
                if (validPasswd() && validConfPasswd()) {
                    changePassword();
                }
                return false;
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: err
                })
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
        crossorigin="anonymous"></script>
</body>

</html>